@using static System.Linq.Enumerable;
@inject GamePlayer game

@code {
  protected override void OnInitialized()
  {
    Action refreshFromAnotherThread = () => this.InvokeAsync(this.StateHasChanged);
    game.OnPositionChanged += refreshFromAnotherThread;
  }
  public async Task CalculatePath()
  {
    System.Console.WriteLine("Started Path Calculation");
    game.CalculateDetailedPath();
    System.Console.WriteLine("Ended Path Calculation");
  }

  public void OptimiseGrid()
  {
    System.Console.WriteLine("Started Grid Optimization");
    game.OptimizeGrid();
    System.Console.WriteLine("Ended Grid Optimization");
  }
  private bool stepInProgress { get; set; } = false;
  public async Task TakeStep()
  {
    stepInProgress = true;
    try
    {
      System.Console.WriteLine("Started Following Path");
      await game.Take1Step();
      System.Console.WriteLine("Ended Following Path");
    }
    catch (Exception e)
    {

      System.Console.WriteLine(e);
      System.Console.WriteLine("Error Following Path");
    }
    finally
    {
      stepInProgress = false;
    }
    CalculatePath();
  }
  public async Task Go()
  {
    await game.PlayGame();
  }
}

<div>

  <button class="@(Styles.Btn) m-3" @onclick="OptimiseGrid">Optimize Grid</button>
  <button class="@(Styles.Btn) m-3" @onclick="CalculatePath">Calculate Path</button>
  <button class="@(Styles.Btn) m-3" @onclick="TakeStep" disabled="@stepInProgress">Take Step</button>
  <button class="@(Styles.Btn) m-3" @onclick="Go">Follow Path</button>

  <div class="flex">

    @if (game.Path != null)
    {
      var classStyle = " m-5";
      @* <div class="text-sm">Path Length: @game.Path.Count()</div> *@
      <div class="@classStyle">Path Cost: @game.Map.CalculatePathCost(game.Path)</div>
      <div class="@classStyle">Battery: @game.Battery</div>
      <div class="@classStyle">Path Calulation Time: @game.LastPathCalulationTime ms</div>
      <div class="@classStyle">Grid Optmization Time: @game.LastGridOptimizationTime ms</div>
    }
  </div>
</div>